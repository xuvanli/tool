

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deck Sketch Tool v12 – unified price (fix duplicate var)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{padding:1rem;user-select:none}
    #deckCanvas{background:#fff;background-image:radial-gradient(circle,#ced4da 1px,transparent 1px);background-size:20px 20px;border:2px dashed #6c757d;width:100%;height:65vh;display:block;touch-action:none;cursor:crosshair}
    .toolbar>*{margin-right:.5rem;margin-bottom:.5rem}
    .toolbar select{min-width:90px}
  </style>
</head>
<body>
  <h2 class="mb-3">Deck Sketch Tool <small class="text-muted">v12</small></h2>
  <div class="toolbar d-flex flex-wrap align-items-center mb-2">
    <button id="finishBtn" class="btn btn-success">Finish</button>
    <button id="undoBtn" class="btn btn-warning">Undo</button>
    <button id="clearBtn" class="btn btn-danger">Clear</button>
    <button id="exportBtn" class="btn btn-secondary">Export JPG</button>
    <div class="input-group" style="width:auto;">
      <label class="input-group-text" for="unitSel">Units</label>
      <select id="unitSel" class="form-select form-select-sm">
        <option value="ft">Feet</option>
        <option value="in" selected>Inches</option>
      </select>
    </div>
  </div>

  <canvas id="deckCanvas"></canvas>
  <div class="mt-3 small">
    <strong>Area:</strong> <span id="areaOut">0</span> ft² &nbsp;|&nbsp;
    <strong>Price:</strong> $<span id="priceOut">0</span> &nbsp;|&nbsp;
    <strong>Railing&nbsp;LF:</strong> <span id="railOut">0</span> ft
  </div>

  <!-- Segment modal -->
  <div class="modal fade" id="lenModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="lenModalTitle">Edit Segment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3"><label class="form-label">Length</label><input id="lenInput" type="number" step="0.1" class="form-control"></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" id="railChk"><label class="form-check-label" for="railChk">This side has railing</label></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="lenSave" class="btn btn-primary">Save</button></div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    /* ===== constants ===== */
    const PX_PER_FT=10,LABEL_OFFSET=10,HIT_R=6,EDGE_HIT=6,HOVER_HIT=10,SNAP_MARK_R=6,SNAP_STEP_RAD=Math.PI/12;

    /* ===== helpers ===== */
    const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
    const snapAngle=a=>Math.round(a/SNAP_STEP_RAD)*SNAP_STEP_RAD;
    const signedArea=pts=>pts.reduce((s,p,i)=>{const q=pts[(i+1)%pts.length];return s+p.x*q.y-q.x*p.y;},0)/2;
    const polyArea=pts=>Math.abs(signedArea(pts));
    const pointSegDist=(p,a,b)=>{const l2=dist(a,b)**2;if(!l2)return dist(p,a);let t=((p.x-a.x)*(b.x-a.x)+(p.y-a.y)*(b.y-a.y))/l2;t=Math.max(0,Math.min(1,t));return dist(p,{x:a.x+t*(b.x-a.x),y:a.y+t*(b.y-a.y)});};

    /* ===== state ===== */
    const cvs=document.getElementById('deckCanvas');const ctx=cvs.getContext('2d');const dpi=window.devicePixelRatio||1;
    let shapes=[],preview=null,unit='in';
    let hover=null,drag=null,edit=null;

    /* ===== DOM refs ===== */
    const areaOut=document.getElementById('areaOut');
    const priceOut=document.getElementById('priceOut');
    const railOut=document.getElementById('railOut');
    const lenInput=document.getElementById('lenInput');
    const railChk=document.getElementById('railChk');
    const modal=new bootstrap.Modal(document.getElementById('lenModal'));

    /* ===== conversions ===== */
    const ftToDisp=ft=>unit==='ft'?ft.toFixed(1):Math.round(ft*12);
    const suff=()=>unit==='ft'?'′':'″';
    const dispToFt=v=>unit==='ft'?v:v/12;

    /* ===== resize ===== */
    function fit(){const r=cvs.getBoundingClientRect();cvs.width=r.width*dpi;cvs.height=r.height*dpi;ctx.setTransform(dpi,0,0,dpi,0,0);draw();}
    window.addEventListener('resize',fit);fit();

    document.getElementById('unitSel').addEventListener('change',e=>{unit=e.target.value;draw();});

    /* ===== drawing primitives ===== */
    function drawSnap(p){ctx.fillStyle='limegreen';ctx.beginPath();ctx.arc(p.x,p.y,SNAP_MARK_R,0,Math.PI*2);ctx.fill();}
    function drawLabel(shape,a,b,i,isPrev=false){
      const midX=(a.x+b.x)/2, midY=(a.y+b.y)/2;
      let nx=b.y-a.y, ny=-(b.x-a.x);
      if(!isPrev && shape.closed && signedArea(shape.verts)>0){ nx=-nx; ny=-ny; }
      const len=Math.hypot(nx,ny)||1; nx/=len; ny/=len;
      const OFFSET=24;
      const x=midX + nx*OFFSET;
      const y=midY + ny*OFFSET;
      const lenFt=dist(a,b)/PX_PER_FT;
      ctx.save();
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillStyle=isPrev?'#ff0000':(shape.railFlags[i]?'#0d6efd':'#343a40');
      ctx.fillText(`${ftToDisp(lenFt)}${suff()}${shape.railFlags[i]?' R':''}`,x,y);
      ctx.restore();
    }
    const hitV=p=>{for(let si=shapes.length-1;si>=0;si--){const idx=shapes[si].verts.findIndex(v=>dist(v,p)<HIT_R);if(idx!==-1)return{s:si,v:idx};}return null;};
    const railSum=shape=>shape.railFlags.reduce((s,f,i)=>f?s+dist(shape.verts[i],shape.verts[(i+1)%shape.verts.length])/PX_PER_FT:s,0);

    /* ===== draw ===== */
    function draw(){const r=cvs.getBoundingClientRect();ctx.clearRect(0,0,r.width,r.height);ctx.lineWidth=2;ctx.font='12px sans-serif';ctx.textBaseline='bottom'; ctx.textAlign='left';shapes.forEach((shape,si)=>{const verts=shape.verts;if(!verts.length)return;ctx.strokeStyle='#0d6efd';ctx.fillStyle='rgba(13,110,253,.1)';ctx.beginPath();ctx.moveTo(verts[0].x,verts[0].y);verts.slice(1).forEach(p=>ctx.lineTo(p.x,p.y));if(shape.closed)ctx.closePath();ctx.stroke();if(shape.closed)ctx.fill();if(hover&&hover.s===si&&verts.length>1){const a=verts[hover.i],b=verts[(hover.i+1)%verts.length];ctx.lineWidth=8;ctx.strokeStyle='rgba(13,110,253,.3)';ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();ctx.lineWidth=2;}const curr=shapes[shapes.length-1];if(preview&&curr===shape&&!shape.closed){ctx.setLineDash([5,5]);ctx.strokeStyle='red';ctx.beginPath();ctx.moveTo(verts.at(-1).x,verts.at(-1).y);ctx.lineTo(preview.x,preview.y);ctx.stroke();ctx.setLineDash([]);drawLabel(shape,verts.at(-1),preview,verts.length-1,true);drawSnap(preview);}if(verts.length>1){const n=shape.closed?verts.length:verts.length-1;const inward=shape.closed&&signedArea(verts)>0;for(let i=0;i<n;i++){const a=verts[i],b=verts[(i+1)%verts.length];if(shape.railFlags[i]){let nx=b.y-a.y,ny=-(b.x-a.x);const len=Math.hypot(nx,ny)||1;nx/=len;ny/=len;if(inward){nx=-nx;ny=-ny;}const OFF=6;ctx.strokeStyle='#0d6efd';ctx.beginPath();ctx.moveTo(a.x+nx*OFF,a.y+ny*OFF);ctx.lineTo(b.x+nx*OFF,b.y+ny*OFF);ctx.stroke();}drawLabel(shape,a,b,i);}}ctx.fillStyle='#212529';verts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();});});const areaFt=shapes.reduce((s,shape)=>s+polyArea(shape.verts)/(PX_PER_FT**2),0);const railFt=shapes.reduce((s,shape)=>s+railSum(shape),0);const totalPrice=areaFt*5+railFt*8;areaOut.textContent=areaFt.toFixed(1);railOut.textContent=railFt.toFixed(1);priceOut.textContent=totalPrice.toFixed(2);}

    /* ===== hover ===== */
    function updHover(pos){hover=null;for(let si=shapes.length-1;si>=0;si--){const verts=shapes[si].verts;if(verts.length>1){const n=shapes[si].closed?verts.length:verts.length-1;for(let i=0;i<n;i++){if(pointSegDist(pos,verts[i],verts[(i+1)%verts.length])<HOVER_HIT){hover={s:si,i};return;}}}}}

    /* ===== modal save ===== */
    document.getElementById('lenSave').addEventListener('click',()=>{const v=parseFloat(lenInput.value);if(!(v>0)||!edit)return;const ft=dispToFt(v);const shape=shapes[edit.s];const a=shape.verts[edit.i];const bIdx=(edit.i+1)%shape.verts.length;const ang=Math.atan2(shape.verts[bIdx].y-a.y,shape.verts[bIdx].x-a.x);shape.verts[bIdx]={x:a.x+ft*PX_PER_FT*Math.cos(ang),y:a.y+ft*PX_PER_FT*Math.sin(ang)};shape.railFlags[edit.i]=railChk.checked;modal.hide();edit=null;draw();});

    /* ===== pointer events ===== */
    cvs.addEventListener('pointerdown',e=>{const rect=cvs.getBoundingClientRect();const pt={x:e.clientX-rect.left,y:e.clientY-rect.top};const hv=hitV(pt);if(hv){drag=hv;cvs.setPointerCapture(e.pointerId);return;}if(hover){edit=hover;const shape=shapes[hover.s];const lenFt=dist(shape.verts[hover.i],shape.verts[(hover.i+1)%shape.verts.length])/PX_PER_FT;lenInput.value=unit==='ft'?lenFt.toFixed(2):(lenFt*12).toFixed(1);railChk.checked=!!shape.railFlags[hover.i];modal.show();return;}let curr=shapes.at(-1);if(!curr||curr.closed){curr={verts:[pt],railFlags:[],closed:false};shapes.push(curr);}else if(preview){curr.verts.push({...preview});curr.railFlags.push(false);preview=null;}else{curr.verts.push(pt);}draw();});
    cvs.addEventListener('pointermove',e=>{const rect=cvs.getBoundingClientRect();const pos={x:e.clientX-rect.left,y:e.clientY-rect.top};if(drag){shapes[drag.s].verts[drag.v]=pos;draw();return;}const curr=shapes.at(-1);if(curr&&!curr.closed&&curr.verts.length){const last=curr.verts.at(-1);const ang=snapAngle(Math.atan2(pos.y-last.y,pos.x-last.x));const len=Math.hypot(pos.x-last.x,pos.y-last.y);preview={x:last.x+len*Math.cos(ang),y:last.y+len*Math.sin(ang)};}else{preview=null;}updHover(pos);draw();});
    cvs.addEventListener('pointerup',e=>{if(drag){drag=null;cvs.releasePointerCapture(e.pointerId);draw();}});
    cvs.addEventListener('pointerleave',()=>{preview=null;hover=null;draw();});

    /* ===== toolbar ===== */
    document.getElementById('finishBtn').onclick=()=>{const curr=shapes.at(-1);if(curr&&!curr.closed&&curr.verts.length>=3){curr.closed=true;preview=null;if(curr.railFlags.length<curr.verts.length)curr.railFlags.length=curr.verts.length;draw();}};
    document.getElementById('undoBtn').onclick=()=>{const curr=shapes.at(-1);if(!curr)return;if(curr.closed)curr.closed=false;else{curr.verts.pop();curr.railFlags.pop();if(!curr.verts.length)shapes.pop();}preview=null;draw();};
    document.getElementById('clearBtn').onclick=()=>{shapes=[];preview=null;hover=null;draw();};
    document.getElementById('exportBtn').onclick=()=>{
      const padding=30*dpi;
      const out=document.createElement('canvas');
      out.width=cvs.width+padding*2;
      out.height=cvs.height+padding*2;
      const octx=out.getContext('2d');
      octx.fillStyle='#fff';
      octx.fillRect(0,0,out.width,out.height);
      octx.drawImage(cvs,padding,padding);
      const link=document.createElement('a');
      link.href=out.toDataURL('image/jpeg');
      link.download='deck.jpg';
      link.click();
    };
  })();
  </script>
</body>
</html>
